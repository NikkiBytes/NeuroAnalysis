
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Connectome-based Predictive Modeling (CPM) &#8212; NeuroAnalysis</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Decoding Cocaine Brainwave Connectivity" href="decoding_brainwaves.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">NeuroAnalysis</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="PCA.html">
   Cocaine Connectivity Data PCA
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="decoding_brainwaves.html">
   Decoding Cocaine Brainwave Connectivity
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Connectome-based Predictive Modeling (CPM)
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/cpm_bevel.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/executablebooks/jupyter-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fcpm_bevel.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/executablebooks/jupyter-book/edit/master/docs/cpm_bevel.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/cpm_bevel.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/executablebooks/jupyter-book/blob/master/docs/cpm_bevel.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#behavioral-setup">
   Behavioral Setup
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#choose-the-behavioral-measure">
     Choose the behavioral measure
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-cpm-on-rl-tasks">
   Run CPM on RL Tasks
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#punish">
     Punish
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reward-task">
     Reward Task
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="connectome-based-predictive-modeling-cpm">
<h1>Connectome-based Predictive Modeling (CPM)<a class="headerlink" href="#connectome-based-predictive-modeling-cpm" title="Permalink to this headline">¶</a></h1>
<p>Predicting behavioral measures from whole-brain functional connectivity. We focus here on the reinforcement learning tasks, reward and punishment, from a set of n=85 subjects from the Bevel dataset.</p>
<p>For the CPM analysis, we need:</p>
<ul class="simple">
<li><p><strong>a set of functional connectivity matrices</strong>, at least one per subject, and,</p></li>
<li><p>a list of behavioral measures for each subject.</p></li>
</ul>
<p>Matrices are stored in a <code class="docutils literal notranslate"><span class="pre">.txt</span></code> file and the behvaioral is in <code class="docutils literal notranslate"><span class="pre">.csv</span></code>.<br />
<br>
<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] installing nilearn for session...&quot;</span><span class="p">)</span>
<span class="o">!</span>pip install nilearn
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[INFO] installing nilearn for session...
Requirement already satisfied: nilearn in /usr/local/lib/python3.6/dist-packages (0.6.2)
Requirement already satisfied: joblib&gt;=0.11 in /usr/local/lib/python3.6/dist-packages (from nilearn) (0.15.1)
Requirement already satisfied: numpy&gt;=1.11 in /usr/local/lib/python3.6/dist-packages (from nilearn) (1.18.4)
Requirement already satisfied: scipy&gt;=0.19 in /usr/local/lib/python3.6/dist-packages (from nilearn) (1.4.1)
Requirement already satisfied: scikit-learn&gt;=0.19 in /usr/local/lib/python3.6/dist-packages (from nilearn) (0.22.2.post1)
Requirement already satisfied: nibabel&gt;=2.0.2 in /usr/local/lib/python3.6/dist-packages (from nilearn) (3.0.2)
Requirement already satisfied: sklearn in /usr/local/lib/python3.6/dist-packages (from nilearn) (0.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_connectome</span>
<span class="kn">from</span> <span class="nn">nilearn.connectome</span> <span class="kn">import</span> <span class="n">ConnectivityMeasure</span>
<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>
<span class="kn">from</span> <span class="nn">IPython.core</span> <span class="kn">import</span> <span class="n">display</span> <span class="k">as</span> <span class="n">ICD</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] mounting google drive directory...</span><span class="se">\n</span><span class="s2">[INFO] if prompted follow the link and copy and paste the token.&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
<span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/content/drive&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[INFO] mounting google drive directory...
[INFO] if prompted follow the link and copy and paste the token.
Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount(&quot;/content/drive&quot;, force_remount=True).
</pre></div>
</div>
</div>
</div>
<p><strong>Helper Functions</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make fc matrices</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Takes timeseries matrices and makes functional connectivity matrices with nilearns ConnectivityMeasure object.</span>
<span class="sd">  We pass a condition, or named here the &#39;file_suffix&#39;, to identify our individual task files,</span>
<span class="sd">  and we pass the number of extracted regions.</span>
<span class="sd">  Outputs: makes subject FCMs, plots FCMs</span>
<span class="sd">  Returns: a function correlation dictionary as well as individual subject list</span>

<span class="sd">  ** Extensions: plotting, save individual FCMs...</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">def</span> <span class="nf">makeFCM</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">timeseries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_regions_extracted</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">file_suffix</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span> <span class="n">functionals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="c1">#print(&#39;[INFO] making functional connectivity matrices with nilearn ConnectivityMeasure object...&#39;)</span>
  <span class="n">fc_corr_dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">subj_list</span><span class="o">=</span><span class="p">[]</span>
  <span class="n">correlations</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="c1"># Initializing ConnectivityMeasure object with kind=&#39;correlation&#39;</span>
  <span class="n">connectome_measure</span> <span class="o">=</span> <span class="n">ConnectivityMeasure</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;correlation&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">subj_timeseries</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">timeseries_matrices</span><span class="p">):</span>
    <span class="n">subj_id</span><span class="o">=</span><span class="n">subj_timeseries</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">subj_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fc_corr_dict</span><span class="p">:</span>
      <span class="n">fc_corr_dict</span><span class="p">[</span><span class="n">subj_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">subj_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subj_list</span><span class="p">:</span>
      <span class="n">subj_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subj_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file_suffix</span> <span class="ow">in</span> <span class="n">subj_timeseries</span><span class="p">:</span>
      <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.txt&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">subj_id</span><span class="p">,</span> <span class="n">file_suffix</span><span class="p">)</span>
      <span class="c1"># we load the text file timeseries into an array </span>
      <span class="n">np_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">subj_timeseries</span><span class="p">)</span>
      <span class="c1"># call fit_transform from ConnectivityMeasure object</span>
      <span class="n">correlation</span> <span class="o">=</span> <span class="n">connectome_measure</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">([</span><span class="n">np_arr</span><span class="p">])</span>
      <span class="c1"># saving each subject correlation to correlations</span>
      <span class="n">fc_corr_dict</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">file_suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlation</span>
      <span class="n">correlations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span>
      
      <span class="c1"># save text</span>
      <span class="c1">#np.savetxt(&#39;/content/&#39;+filename, correlation.transpose(2,0,1).reshape(3,-1))</span>

    <span class="c1"># Mean of all correlations</span>
  <span class="n">mean_correlations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">correlations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_regions_extracted</span><span class="p">,</span> <span class="n">n_regions_extracted</span><span class="p">)</span>



  <span class="c1">## plotting</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[INFO] Plot of the mean functional connectivity matrix: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Correlation between </span><span class="si">%d</span><span class="s1"> regions, condition </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n_regions_extracted</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>
  <span class="c1"># First plot the matrix</span>
  <span class="n">display</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">plot_matrix</span><span class="p">(</span><span class="n">mean_correlations</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="c1"># Then find the center of the regions and plot a connectome</span>
  <span class="c1">#regions_img = regions_extracted_img</span>
  <span class="c1">#coords_connectome = plotting.find_probabilistic_atlas_cut_coords(regions_img)</span>

  <span class="c1">#plotting.plot_connectome(mean_correlations, coords_connectome,</span>
                          <span class="c1">#edge_threshold=&#39;90%&#39;, title=title)</span>
        
  <span class="k">return</span> <span class="n">fc_corr_dict</span><span class="p">,</span> <span class="n">subj_list</span><span class="p">;</span>



  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_in_matrices</span><span class="p">(</span><span class="n">subj_list</span><span class="p">,</span> <span class="n">fc_corr_dict</span><span class="p">,</span> <span class="n">file_suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">zscore</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in a set of individual-subject connectivity matrices stored in data_dir,</span>
<span class="sd">    </span>
<span class="sd">    Returns a dataframe that is subjects x edges (by vectorizing the upper triangle of each FC matrix).</span>
<span class="sd">    </span>
<span class="sd">    Assumes:</span>
<span class="sd">    - each matrix is stored in a separate file beginning with the subject ID, and</span>
<span class="sd">    - matrices are symmetric (squareform); i.e., for a parcellation with 268 nodes, matrices should be 268 x 268</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">all_fc_data</span> <span class="o">=</span> <span class="p">{}</span>
            
    <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subj_list</span><span class="p">:</span>
        <span class="c1"># try to find this subject&#39;s matrix</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">file_suffix</span><span class="p">:</span>
              <span class="c1"># make list files found</span>
              <span class="n">matrix</span> <span class="o">=</span> <span class="n">fc_corr_dict</span><span class="p">[</span><span class="n">subj</span><span class="p">][</span><span class="n">file_suffix</span><span class="p">]</span>
            <span class="c1">#file = [f for f in matrices if subj in f and file_suffix in f]</span>
        <span class="c1">#else:</span>
            <span class="c1">#file = [f for f in matrices if subj in f]</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="k">pass</span>    
        <span class="c1"># make sure there is one and only one file    </span>
        <span class="c1">#if len(file) ==0:</span>
            <span class="c1">#raise ValueError(&quot;No data found for subject {}&quot;.format(subj))</span>
        <span class="c1">#if len(file) &gt;1:</span>
            <span class="c1">#raise ValueError(&quot;More than one matrix found for subject {}! Specify a suffix?&quot;.format(subj))</span>
        
        <span class="c1"># read it in and make sure it&#39;s symmetric and has reasonable dimensions</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Matrix seems to have incorrect dimensions: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
        <span class="c1"># take just the upper triangle and store it in a dictionary</span>
        <span class="k">if</span> <span class="o">~</span><span class="n">zscore</span><span class="p">:</span>
            <span class="n">all_fc_data</span><span class="p">[</span><span class="n">subj</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices_from</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">zscore</span><span class="p">:</span>
            <span class="n">all_fc_data</span><span class="p">[</span><span class="n">subj</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices_from</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
        
    <span class="c1"># Convert dictionary into dataframe</span>
    <span class="n">all_fc_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">all_fc_data</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="c1">#print(&#39;[INFO] made functional connectivity matrix dataframe.&#39;)</span>


    <span class="k">return</span> <span class="n">all_fc_data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mk_kfold_indices</span><span class="p">(</span><span class="n">subj_list</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits list of subjects into k folds for cross-validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">n_subs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subj_list</span><span class="p">)</span>
    <span class="n">n_subs_per_fold</span> <span class="o">=</span> <span class="n">n_subs</span><span class="o">//</span><span class="n">k</span> <span class="c1"># floor integer for n_subs_per_fold</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fold_no</span><span class="p">]</span><span class="o">*</span><span class="n">n_subs_per_fold</span> <span class="k">for</span> <span class="n">fold_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="c1"># generate repmat list of indices</span>
    <span class="n">remainder</span> <span class="o">=</span> <span class="n">n_subs</span> <span class="o">%</span> <span class="n">k</span> <span class="c1"># figure out how many subs are left over</span>
    <span class="n">remainder_inds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">remainder</span><span class="p">))</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">indices</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>    
    <span class="p">[</span><span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">remainder_inds</span><span class="p">]</span> <span class="c1"># add indices for remainder subs</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">==</span><span class="n">n_subs</span><span class="p">,</span> <span class="s2">&quot;Length of indices list does not equal number of subjects, something went wrong&quot;</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="c1"># shuffles in place</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">split_train_test</span><span class="p">(</span><span class="n">subj_list</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">test_fold</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a subj list, k-fold indices, and given fold, returns lists of train_subs and test_subs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indices</span><span class="o">!=</span><span class="n">test_fold</span><span class="p">)</span>
    <span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indices</span><span class="o">==</span><span class="n">test_fold</span><span class="p">)</span>

    <span class="n">train_subs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subj_list</span><span class="p">[</span><span class="n">train_inds</span><span class="p">]:</span>
        <span class="n">train_subs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>

    <span class="n">test_subs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subj_list</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]:</span>
        <span class="n">test_subs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">train_subs</span><span class="p">,</span> <span class="n">test_subs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_train_test_data</span><span class="p">(</span><span class="n">all_fc_data</span><span class="p">,</span> <span class="n">train_subs</span><span class="p">,</span> <span class="n">test_subs</span><span class="p">,</span> <span class="n">behav_data</span><span class="p">,</span> <span class="n">behav</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts requested FC and behavioral data for a list of train_subs and test_subs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">train_vcts</span> <span class="o">=</span> <span class="n">all_fc_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_subs</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">test_vcts</span> <span class="o">=</span> <span class="n">all_fc_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_subs</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">train_behav</span> <span class="o">=</span> <span class="n">behav_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_subs</span><span class="p">,</span> <span class="n">behav</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">train_vcts</span><span class="p">,</span> <span class="n">train_behav</span><span class="p">,</span> <span class="n">test_vcts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select_features</span><span class="p">(</span><span class="n">train_vcts</span><span class="p">,</span> <span class="n">train_behav</span><span class="p">,</span> <span class="n">r_thresh</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">corr_type</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the CPM feature selection step: </span>
<span class="sd">    - correlates each edge with behavior, and returns a mask of edges that are correlated above some threshold, one for each tail (positive and negative)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">train_vcts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">train_behav</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s2">&quot;Row indices of FC vcts and behavior don&#39;t match!&quot;</span>

    <span class="c1"># Correlate all edges with behav vector</span>
    <span class="k">if</span> <span class="n">corr_type</span> <span class="o">==</span><span class="s1">&#39;pearson&#39;</span><span class="p">:</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">train_behav</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">train_behav</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">train_vcts</span> <span class="o">-</span> <span class="n">train_vcts</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">train_behav</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">train_behav</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">train_vcts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">corr_type</span> <span class="o">==</span><span class="s1">&#39;spearman&#39;</span><span class="p">:</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">train_vcts</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">r_val</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">train_vcts</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">edge</span><span class="p">],</span> <span class="n">train_behav</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">corr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_val</span><span class="p">)</span>

    <span class="c1"># Define positive and negative masks</span>
    <span class="n">mask_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mask_dict</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span> <span class="o">&gt;</span> <span class="n">r_thresh</span>
    <span class="n">mask_dict</span><span class="p">[</span><span class="s2">&quot;neg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">r_thresh</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found (</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">) edges positively/negatively correlated with behavior in the training set&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mask_dict</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">mask_dict</span><span class="p">[</span><span class="s2">&quot;neg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span> <span class="c1"># for debugging</span>

    <span class="k">return</span> <span class="n">mask_dict</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">train_vcts</span><span class="p">,</span> <span class="n">mask_dict</span><span class="p">,</span> <span class="n">train_behav</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds a CPM model:</span>
<span class="sd">    - takes a feature mask, sums all edges in the mask for each subject, and uses simple linear regression to relate summed network strength to behavior</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">train_vcts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">train_behav</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s2">&quot;[ERROR FOUND] Row indices of FC vcts and behavior don&#39;t match!&quot;</span>

    <span class="n">model_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Loop through pos and neg tails</span>
    <span class="n">X_glm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">train_vcts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>

    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">tail</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">mask_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">train_vcts</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">X_glm</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">train_behav</span>
        
        <span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">model_dict</span><span class="p">[</span><span class="n">tail</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">)</span>
        <span class="n">t</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">X_glm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">X_glm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X_glm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;glm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X_glm</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">model_dict</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">apply_model</span><span class="p">(</span><span class="n">test_vcts</span><span class="p">,</span> <span class="n">mask_dict</span><span class="p">,</span> <span class="n">model_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a previously trained linear regression model to a test set to generate predictions of behavior.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">behav_pred</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">X_glm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">test_vcts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>

    <span class="c1"># Loop through pos and neg tails</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">tail</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">mask_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="c1">#print(tail, mask)</span>
      <span class="n">X</span> <span class="o">=</span> <span class="n">test_vcts</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">X_glm</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>

      <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="n">tail</span><span class="p">]</span>
      <span class="n">behav_pred</span><span class="p">[</span><span class="n">tail</span><span class="p">]</span> <span class="o">=</span> <span class="n">slope</span><span class="o">*</span><span class="n">X</span> <span class="o">+</span> <span class="n">intercept</span>
      <span class="n">t</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">X_glm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">X_glm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X_glm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">behav_pred</span><span class="p">[</span><span class="s2">&quot;glm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X_glm</span><span class="p">,</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;glm&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">behav_pred</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cpm_wrapper</span><span class="p">(</span><span class="n">all_fc_data</span><span class="p">,</span> <span class="n">all_behav_data</span><span class="p">,</span><span class="n">condition</span><span class="p">,</span> <span class="n">behav</span><span class="p">,</span>  <span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">cpm_kwargs</span><span class="p">):</span>

    <span class="k">assert</span> <span class="n">all_fc_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">all_behav_data</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s2">&quot;Row (subject) indices of FC vcts and behavior don&#39;t match!&quot;</span>

    <span class="n">subj_list</span> <span class="o">=</span> <span class="n">all_fc_data</span><span class="o">.</span><span class="n">index</span> <span class="c1"># get subj_list from df index</span>
    
    <span class="n">indices</span> <span class="o">=</span> <span class="n">mk_kfold_indices</span><span class="p">(</span><span class="n">subj_list</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    
    <span class="c1"># Initialize df for storing observed and predicted behavior</span>
    <span class="n">col_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tail</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;neg&quot;</span><span class="p">,</span> <span class="s2">&quot;glm&quot;</span><span class="p">]:</span>
        <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">behav</span> <span class="o">+</span> <span class="s2">&quot; predicted (&quot;</span> <span class="o">+</span> <span class="n">tail</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">behav</span> <span class="o">+</span> <span class="s2">&quot; observed&quot;</span><span class="p">)</span>
    <span class="n">behav_obs_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">subj_list</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">col_list</span><span class="p">)</span>
    
    <span class="c1"># Initialize array for storing feature masks</span>
    <span class="n">n_edges</span> <span class="o">=</span> <span class="n">all_fc_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">all_masks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">all_masks</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">n_edges</span><span class="p">))</span>
    <span class="n">all_masks</span><span class="p">[</span><span class="s2">&quot;neg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">n_edges</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="c1">#print(&quot;[INFO] doing fold {}&quot;.format(fold))</span>
        <span class="n">train_subs</span><span class="p">,</span> <span class="n">test_subs</span> <span class="o">=</span> <span class="n">split_train_test</span><span class="p">(</span><span class="n">subj_list</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">test_fold</span><span class="o">=</span><span class="n">fold</span><span class="p">)</span>
        <span class="n">train_vcts</span><span class="p">,</span> <span class="n">train_behav</span><span class="p">,</span> <span class="n">test_vcts</span> <span class="o">=</span> <span class="n">get_train_test_data</span><span class="p">(</span><span class="n">all_fc_data</span><span class="p">,</span> <span class="n">train_subs</span><span class="p">,</span> <span class="n">test_subs</span><span class="p">,</span> <span class="n">all_behav_data</span><span class="p">,</span> <span class="n">behav</span><span class="o">=</span><span class="n">behav</span><span class="p">)</span>
        <span class="n">mask_dict</span> <span class="o">=</span> <span class="n">select_features</span><span class="p">(</span><span class="n">train_vcts</span><span class="p">,</span> <span class="n">train_behav</span><span class="p">,</span> <span class="o">**</span><span class="n">cpm_kwargs</span><span class="p">)</span>
        <span class="n">all_masks</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">][</span><span class="n">fold</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">mask_dict</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span>
        <span class="n">all_masks</span><span class="p">[</span><span class="s2">&quot;neg&quot;</span><span class="p">][</span><span class="n">fold</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">mask_dict</span><span class="p">[</span><span class="s2">&quot;neg&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">model_dict</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">train_vcts</span><span class="p">,</span> <span class="n">mask_dict</span><span class="p">,</span> <span class="n">train_behav</span><span class="p">)</span>
          <span class="c1">#print(model_dict.keys())</span>
          <span class="c1">#print(&quot;[INFO] model building complete.&quot;)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ERROR FOUND] </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">behav_pred</span> <span class="o">=</span> <span class="n">apply_model</span><span class="p">(</span><span class="n">test_vcts</span><span class="p">,</span> <span class="n">mask_dict</span><span class="p">,</span> <span class="n">model_dict</span><span class="p">)</span>
          <span class="c1">#print(&quot;[INFO] glm applied, behavior predicted with test set.&quot;)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ERROR FOUND] </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">tail</span><span class="p">,</span> <span class="n">predictions</span> <span class="ow">in</span> <span class="n">behav_pred</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">behav_obs_pred</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_subs</span><span class="p">,</span> <span class="n">behav</span> <span class="o">+</span> <span class="s2">&quot; predicted (&quot;</span> <span class="o">+</span> <span class="n">tail</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span>
            
    <span class="n">behav_obs_pred</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subj_list</span><span class="p">,</span> <span class="n">behav</span> <span class="o">+</span> <span class="s2">&quot; observed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_behav_data</span><span class="p">[</span><span class="n">behav</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">behav_obs_pred</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[INFO] CPM completed with </span><span class="si">%s</span><span class="s1"> folds.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">behav_obs_pred</span><span class="p">,</span> <span class="n">all_masks</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_predictions</span><span class="p">(</span><span class="n">behav_obs_pred</span><span class="p">,</span><span class="n">color</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="s2">&quot;glm&quot;</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">behav_obs_pred</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">behav_obs_pred</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="p">(</span><span class="n">tail</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">ax_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()),</span> <span class="nb">min</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()))</span>
    <span class="n">ax_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()),</span> <span class="nb">max</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax_min</span><span class="p">,</span> <span class="n">ax_max</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ax_min</span><span class="p">,</span> <span class="n">ax_max</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>

    <span class="c1">#print(y.columns.values)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;BMI observed&#39;</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;BMI predicted (glm)&#39;</span><span class="p">])</span>
    <span class="n">r_value</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;r = </span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r_value</span><span class="p">),</span> <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="n">xycoords</span> <span class="o">=</span> <span class="s1">&#39;axes fraction&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">g</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_consistent_edges</span><span class="p">(</span><span class="n">all_masks</span><span class="p">,</span> <span class="n">roi_coords</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">):</span>
    
    <span class="n">edge_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_masks</span><span class="p">[</span><span class="n">tail</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">all_masks</span><span class="p">[</span><span class="n">tail</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">edge_frac_square</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">squareform</span><span class="p">(</span><span class="n">edge_frac</span><span class="p">)</span>

    <span class="n">node_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">edge_frac_square</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">thresh</span> <span class="c1"># find nodes that have at least one edge that passes the threshold</span>
    <span class="n">node_size</span> <span class="o">=</span> <span class="n">edge_frac_square</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">node_mask</span><span class="o">*</span><span class="mi">20</span> <span class="c1"># size nodes based on how many suprathreshold edges they have</span>

    <span class="n">plot_connectome</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="o">=</span><span class="n">edge_frac_square</span><span class="p">,</span> <span class="n">edge_threshold</span><span class="o">=</span><span class="n">thresh</span><span class="p">,</span>
                    <span class="n">node_color</span> <span class="o">=</span> <span class="n">color</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">tail</span><span class="p">,</span> <span class="n">node_coords</span><span class="o">=</span><span class="n">roi_coords</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="n">node_size</span><span class="p">,</span>
                    <span class="n">display_mode</span><span class="o">=</span> <span class="s1">&#39;lzry&#39;</span><span class="p">,</span>
                    <span class="n">edge_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">})</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For the </span><span class="si">{}</span><span class="s2"> tail, </span><span class="si">{}</span><span class="s2"> edges were selected in at least </span><span class="si">{}% o</span><span class="s2">f folds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tail</span><span class="p">,</span> <span class="p">(</span><span class="n">edge_frac</span><span class="o">&gt;=</span><span class="n">thresh</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">thresh</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cpmPipeline</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span><span class="n">condition</span><span class="p">,</span> <span class="n">behav</span><span class="p">,</span> <span class="n">matrices_path</span><span class="p">,</span> <span class="n">cpm_kwargs</span><span class="p">,</span> <span class="n">behavioral</span><span class="p">,</span><span class="n">cond_color</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
  <span class="c1"># first step compute timeseries matrix</span>
  <span class="n">timeseries_matrices</span><span class="o">=</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrices_path</span><span class="p">,</span> <span class="s2">&quot;*.txt&quot;</span><span class="p">))</span>
  <span class="n">fc_corr_dict</span><span class="p">,</span><span class="n">subj_list</span><span class="o">=</span><span class="n">makeFCM</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">timeseries_matrices</span><span class="p">,</span> <span class="n">file_suffix</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span> <span class="n">functionals</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
  <span class="c1"># make functional connectivity matrix of all subjects</span>
  <span class="n">all_fc_data</span> <span class="o">=</span> <span class="n">read_in_matrices</span><span class="p">(</span><span class="n">behavioral</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">fc_corr_dict</span><span class="p">,</span><span class="n">file_suffix</span><span class="o">=</span><span class="n">condition</span><span class="p">)</span>
  <span class="c1"># replace infinite values with nan</span>
  <span class="n">all_fc_data</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
  <span class="c1"># fill nan values with column average</span>
  <span class="n">all_fc_data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">all_fc_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="n">behav_obs_pred</span><span class="p">,</span> <span class="n">all_masks</span> <span class="o">=</span> <span class="n">cpm_wrapper</span><span class="p">(</span><span class="n">all_fc_data</span><span class="p">,</span> <span class="n">behavioral</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">behav</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">cpm_kwargs</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">ICD</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">behav_obs_pred</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
  <span class="c1"># plot scatter plot</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Plot of Observed vs. Predicted Behavior </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="n">g</span> <span class="o">=</span> <span class="n">plot_predictions</span><span class="p">(</span><span class="n">behav_obs_pred</span><span class="p">,</span><span class="n">cond_color</span><span class="p">)</span>
  <span class="n">g</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">roi_coords</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;betaseries_rois.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="n">roi_coords</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="c1">#ICD.display(roi_coords.head())</span>
  <span class="n">plot_consistent_edges</span><span class="p">(</span><span class="n">all_masks</span><span class="p">,</span> <span class="n">roi_coords</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;deeppink&#39;</span><span class="p">)</span>
  <span class="n">plot_consistent_edges</span><span class="p">(</span><span class="n">all_masks</span><span class="p">,</span> <span class="n">roi_coords</span><span class="p">,</span> <span class="s2">&quot;neg&quot;</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;purple&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">behav</span><span class="p">,</span> <span class="n">cond_color</span><span class="p">,</span><span class="n">matrices_path</span><span class="p">,</span><span class="n">cmap</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
  <span class="c1">#setup input parameters </span>
  <span class="n">matrices_path</span><span class="o">=</span><span class="s1">&#39;/content&#39;</span>
  <span class="n">cpm_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;r_thresh&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;corr_type&#39;</span><span class="p">:</span> <span class="s1">&#39;pearson&#39;</span><span class="p">}</span> <span class="c1"># these are the defaults, but it&#39;s still good to be explicit</span>

  <span class="c1">#run pipeline</span>
  <span class="n">cpmPipeline</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span><span class="n">condition</span><span class="p">,</span> <span class="n">behav</span><span class="p">,</span> <span class="n">matrices_path</span><span class="p">,</span> <span class="n">cpm_kwargs</span><span class="p">,</span> <span class="n">behavioral</span><span class="p">,</span> <span class="n">cond_color</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="behavioral-setup">
<h2>Behavioral Setup<a class="headerlink" href="#behavioral-setup" title="Permalink to this headline">¶</a></h2>
<p><strong>Load in the behavioral <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file and modify for input</strong></p>
<p>For the behavioral file the ID column was modified, replacing “bevel” prefix with “sub-0”, to match the FCM input. The ID column is then set to the index and renamed to “Subject”. The ids not found in the subject list are dropped from behavioral, and NaN values are filled with 0.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># behavioral </span>
<span class="n">behavioral_file</span><span class="o">=</span><span class="s1">&#39;/content/clean_bevel.csv&#39;</span>

<span class="n">behavioral</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">behavioral_file</span><span class="p">)</span>
<span class="n">behavioral</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">behavioral</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Bevel&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-0&#39;</span><span class="p">)</span>
<span class="n">behavioral</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">behavioral</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;bevel&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-0&#39;</span><span class="p">)</span>
<span class="n">behavioral</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">behavioral</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Subject&quot;</span>
<span class="c1">#remove subjects that were dropped</span>
<span class="n">remove_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">behavioral</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subj_list</span><span class="p">]</span>
<span class="n">behavioral</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">remove_ids</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">behavioral</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">behavioral</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>intials</th>
      <th>date</th>
      <th>weight</th>
      <th>height</th>
      <th>BMI</th>
      <th>BMI_cat</th>
      <th>hba1c</th>
      <th>bloodglucose</th>
      <th>bitter</th>
      <th>age</th>
      <th>DOB</th>
      <th>hispanic</th>
      <th>race1</th>
      <th>sex</th>
      <th>mens_date</th>
      <th>mens_length</th>
      <th>sensitivity_reward</th>
      <th>sensitivity_punish</th>
      <th>test_result_group</th>
      <th>preTTfullness</th>
      <th>preTThunger</th>
      <th>preTTthirst</th>
      <th>hourssincelastmeal</th>
      <th>sweetstim_level</th>
      <th>sweetstim_pleasent</th>
      <th>sweetstim_desire</th>
      <th>sweetstim_intense</th>
      <th>sweetstim_bitter</th>
      <th>sweetstim_sweet</th>
      <th>bitterstim_level</th>
      <th>bitterstim_pleasent</th>
      <th>bitterstim_desire</th>
      <th>bitterstim_intense</th>
      <th>bitterstim_bitter</th>
      <th>bitterstim_sweet</th>
      <th>sweet1pleasent</th>
      <th>sweet1desire</th>
      <th>sweet1intense</th>
      <th>sweet1bitter</th>
      <th>sweet1sweet</th>
      <th>...</th>
      <th>RT_cd</th>
      <th>RT_ef</th>
      <th>%_correct</th>
      <th>%correct_run1</th>
      <th>%correct_run2</th>
      <th>%correct_run3</th>
      <th>%correct_run4</th>
      <th>%correct_ab_run1</th>
      <th>%correct_ab_run2</th>
      <th>%correct_ab_run3</th>
      <th>%correct_ab_run4</th>
      <th>trials_AB_run1</th>
      <th>trials_AB_run2</th>
      <th>trials_AB_run3</th>
      <th>trials_AB_run4</th>
      <th>%correct_cd_run1</th>
      <th>%correct_cd_run2</th>
      <th>%correct_cd_run3</th>
      <th>%correct_cd_run4</th>
      <th>trials_cd_run1</th>
      <th>trials_cd_run2</th>
      <th>trials_cd_run3</th>
      <th>trials_cd_run4</th>
      <th>%correct_ef_run1</th>
      <th>%correct_ef_run2</th>
      <th>%correct_ef_run3</th>
      <th>%correct_ef_run4</th>
      <th>trials_ef_run1</th>
      <th>trials_ef_run2</th>
      <th>trials_ef_run3</th>
      <th>trials_ef_run4</th>
      <th>taste_run1</th>
      <th>taste_run2</th>
      <th>taste_run3</th>
      <th>taste_run4</th>
      <th>notes</th>
      <th>alpha_pos</th>
      <th>alpha_neg</th>
      <th>criteria_met</th>
      <th>training_slope</th>
    </tr>
    <tr>
      <th>Subject</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sub-001</th>
      <td>JRS</td>
      <td>3/19/18</td>
      <td>77.6</td>
      <td>178.0</td>
      <td>24.5</td>
      <td>HW</td>
      <td>4.5</td>
      <td>94</td>
      <td>2</td>
      <td>24</td>
      <td>5/5/93</td>
      <td>non-hispanic</td>
      <td>caucasian</td>
      <td>male</td>
      <td>0</td>
      <td>0</td>
      <td>0.555556</td>
      <td>0.833333</td>
      <td>learner</td>
      <td>-70</td>
      <td>65</td>
      <td>23</td>
      <td>0.0</td>
      <td>2</td>
      <td>21</td>
      <td>25</td>
      <td>14</td>
      <td>14</td>
      <td>12</td>
      <td>2</td>
      <td>-39</td>
      <td>-63</td>
      <td>51</td>
      <td>52</td>
      <td>-17</td>
      <td>3</td>
      <td>4</td>
      <td>-35</td>
      <td>-19</td>
      <td>-24</td>
      <td>...</td>
      <td>1.604</td>
      <td>1.595</td>
      <td>49.00%</td>
      <td>52.20%</td>
      <td>54.20%</td>
      <td>34.60%</td>
      <td>56.50%</td>
      <td>63.60%</td>
      <td>57.10%</td>
      <td>25.00%</td>
      <td>54.50%</td>
      <td>11</td>
      <td>7</td>
      <td>12.0</td>
      <td>11.0</td>
      <td>44.40%</td>
      <td>50.00%</td>
      <td>42.90%</td>
      <td>66.70%</td>
      <td>9</td>
      <td>10</td>
      <td>7.0</td>
      <td>6.0</td>
      <td>33.30%</td>
      <td>57.10%</td>
      <td>42.90%</td>
      <td>50.00%</td>
      <td>3</td>
      <td>7</td>
      <td>7.0</td>
      <td>6.0</td>
      <td>23</td>
      <td>24</td>
      <td>26</td>
      <td>23</td>
      <td>good</td>
      <td>0.350563</td>
      <td>0.638784</td>
      <td>0</td>
      <td>neg_slope</td>
    </tr>
    <tr>
      <th>sub-002</th>
      <td>JRS</td>
      <td>3/21/18</td>
      <td>56.0</td>
      <td>167.0</td>
      <td>20.1</td>
      <td>HW</td>
      <td>4.6</td>
      <td>94</td>
      <td>2</td>
      <td>19</td>
      <td>10/22/98</td>
      <td>non-hispanic</td>
      <td>asian</td>
      <td>female</td>
      <td>3/9/18</td>
      <td>4</td>
      <td>0.590909</td>
      <td>0.625000</td>
      <td>learner</td>
      <td>34</td>
      <td>-24</td>
      <td>68</td>
      <td>5.0</td>
      <td>4</td>
      <td>48</td>
      <td>38</td>
      <td>15</td>
      <td>-100</td>
      <td>15</td>
      <td>4</td>
      <td>-34</td>
      <td>-28</td>
      <td>38</td>
      <td>22</td>
      <td>-35</td>
      <td>24</td>
      <td>15</td>
      <td>11</td>
      <td>-98</td>
      <td>6</td>
      <td>...</td>
      <td>1.604</td>
      <td>1.602</td>
      <td>56.60%</td>
      <td>50.00%</td>
      <td>72.00%</td>
      <td>57.70%</td>
      <td>46.20%</td>
      <td>33.30%</td>
      <td>66.70%</td>
      <td>45.50%</td>
      <td>0.00%</td>
      <td>6</td>
      <td>6</td>
      <td>11.0</td>
      <td>4.0</td>
      <td>57.10%</td>
      <td>85.70%</td>
      <td>40.00%</td>
      <td>57.10%</td>
      <td>7</td>
      <td>7</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>55.60%</td>
      <td>66.70%</td>
      <td>80.00%</td>
      <td>53.30%</td>
      <td>9</td>
      <td>12</td>
      <td>10.0</td>
      <td>15.0</td>
      <td>22</td>
      <td>25</td>
      <td>26</td>
      <td>26</td>
      <td>good</td>
      <td>0.352071</td>
      <td>0.638182</td>
      <td>0</td>
      <td>neg_slope</td>
    </tr>
    <tr>
      <th>sub-003</th>
      <td>JRS</td>
      <td>3/23/18</td>
      <td>72.5</td>
      <td>153.5</td>
      <td>30.8</td>
      <td>OB</td>
      <td>4.8</td>
      <td>85</td>
      <td>2</td>
      <td>23</td>
      <td>4/6/94</td>
      <td>non-hispanic</td>
      <td>caucasian</td>
      <td>female</td>
      <td>2/28/18</td>
      <td>28</td>
      <td>0.583333</td>
      <td>0.521739</td>
      <td>learner</td>
      <td>-49</td>
      <td>35</td>
      <td>47</td>
      <td>5.0</td>
      <td>2</td>
      <td>4</td>
      <td>20</td>
      <td>-2</td>
      <td>-65</td>
      <td>14</td>
      <td>4</td>
      <td>-13</td>
      <td>-16</td>
      <td>21</td>
      <td>55</td>
      <td>13</td>
      <td>-8</td>
      <td>-8</td>
      <td>14</td>
      <td>12</td>
      <td>17</td>
      <td>...</td>
      <td>1.586</td>
      <td>1.583</td>
      <td>46.60%</td>
      <td>60.00%</td>
      <td>50.00%</td>
      <td>23.10%</td>
      <td>53.80%</td>
      <td>44.40%</td>
      <td>57.10%</td>
      <td>36.40%</td>
      <td>41.70%</td>
      <td>9</td>
      <td>7</td>
      <td>11.0</td>
      <td>12.0</td>
      <td>55.60%</td>
      <td>46.20%</td>
      <td>25.00%</td>
      <td>66.70%</td>
      <td>9</td>
      <td>13</td>
      <td>8.0</td>
      <td>6.0</td>
      <td>85.70%</td>
      <td>50.00%</td>
      <td>0.00%</td>
      <td>62.50%</td>
      <td>7</td>
      <td>6</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>25</td>
      <td>26</td>
      <td>26</td>
      <td>26</td>
      <td>good</td>
      <td>0.351216</td>
      <td>0.639118</td>
      <td>0</td>
      <td>neg_slope</td>
    </tr>
    <tr>
      <th>sub-004</th>
      <td>JRS, MAN</td>
      <td>4/26/18</td>
      <td>54.5</td>
      <td>166.5</td>
      <td>19.7</td>
      <td>HW</td>
      <td>5.0</td>
      <td>80</td>
      <td>1</td>
      <td>24</td>
      <td>6/27/93</td>
      <td>non-hispanic</td>
      <td>caucasian</td>
      <td>female</td>
      <td>3/15/18</td>
      <td>Sporadic</td>
      <td>0.600000</td>
      <td>0.450000</td>
      <td>reward_learner</td>
      <td>-65</td>
      <td>60</td>
      <td>72</td>
      <td>9.0</td>
      <td>3</td>
      <td>-15</td>
      <td>-23</td>
      <td>0</td>
      <td>12</td>
      <td>15</td>
      <td>2</td>
      <td>-11</td>
      <td>-25</td>
      <td>20</td>
      <td>22</td>
      <td>0</td>
      <td>-40</td>
      <td>-64</td>
      <td>36</td>
      <td>36</td>
      <td>-34</td>
      <td>...</td>
      <td>1.593</td>
      <td>1.590</td>
      <td>56.40%</td>
      <td>58.30%</td>
      <td>57.70%</td>
      <td>50.00%</td>
      <td>60.00%</td>
      <td>66.70%</td>
      <td>62.50%</td>
      <td>44.40%</td>
      <td>53.80%</td>
      <td>9</td>
      <td>8</td>
      <td>9.0</td>
      <td>13.0</td>
      <td>50.00%</td>
      <td>36.40%</td>
      <td>44.40%</td>
      <td>75.00%</td>
      <td>10</td>
      <td>11</td>
      <td>9.0</td>
      <td>8.0</td>
      <td>60.00%</td>
      <td>85.70%</td>
      <td>62.50%</td>
      <td>50.00%</td>
      <td>5</td>
      <td>7</td>
      <td>8.0</td>
      <td>4.0</td>
      <td>24</td>
      <td>26</td>
      <td>26</td>
      <td>25</td>
      <td>good</td>
      <td>0.350969</td>
      <td>0.638079</td>
      <td>0</td>
      <td>neg_slope</td>
    </tr>
    <tr>
      <th>sub-005</th>
      <td>J</td>
      <td>3/28/18</td>
      <td>50.5</td>
      <td>160.5</td>
      <td>19.6</td>
      <td>HW</td>
      <td>0.0</td>
      <td>94</td>
      <td>1</td>
      <td>18</td>
      <td>7/18/99</td>
      <td>non-hispanic</td>
      <td>asian</td>
      <td>female</td>
      <td>3/21/18</td>
      <td>30</td>
      <td>0.333333</td>
      <td>0.416667</td>
      <td>nonlearner</td>
      <td>-100</td>
      <td>74</td>
      <td>47</td>
      <td>7.0</td>
      <td>4</td>
      <td>56</td>
      <td>55</td>
      <td>50</td>
      <td>-81</td>
      <td>50</td>
      <td>4</td>
      <td>-70</td>
      <td>-67</td>
      <td>100</td>
      <td>70</td>
      <td>-100</td>
      <td>-26</td>
      <td>-39</td>
      <td>23</td>
      <td>30</td>
      <td>-7</td>
      <td>...</td>
      <td>1.592</td>
      <td>1.588</td>
      <td>52.10%</td>
      <td>56.00%</td>
      <td>38.50%</td>
      <td>56.00%</td>
      <td>60.00%</td>
      <td>70.00%</td>
      <td>45.50%</td>
      <td>83.30%</td>
      <td>77.80%</td>
      <td>10</td>
      <td>11</td>
      <td>6.0</td>
      <td>9.0</td>
      <td>36.40%</td>
      <td>16.70%</td>
      <td>66.70%</td>
      <td>33.30%</td>
      <td>11</td>
      <td>6</td>
      <td>6.0</td>
      <td>3.0</td>
      <td>75.00%</td>
      <td>44.40%</td>
      <td>38.50%</td>
      <td>50.00%</td>
      <td>4</td>
      <td>9</td>
      <td>13.0</td>
      <td>8.0</td>
      <td>25</td>
      <td>26</td>
      <td>25</td>
      <td>20</td>
      <td>good</td>
      <td>0.352031</td>
      <td>0.637929</td>
      <td>0</td>
      <td>pos_slope</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 409 columns</p>
</div></div></div>
</div>
<div class="section" id="choose-the-behavioral-measure">
<h3>Choose the behavioral measure<a class="headerlink" href="#choose-the-behavioral-measure" title="Permalink to this headline">¶</a></h3>
<p>It’s a good idea to look at a histogram to make sure there is actually variability across subjects, and the distribution isn’t too skewed.<br />
<em>Note that if your behavior is highly skewed (i.e., non-normally distributed), you should consider using Spearman (rank) correlation in the CPM feature selection step (you can do this by setting corr_type to spearman [default pearson] in the cpm_kwargs dictionary).</em></p>
<p>View behavior measures we can choose from:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#print(&#39;\n&#39;.join(behavioral.columns.values))</span>
</pre></div>
</div>
</div>
</div>
<p>Looking at BMI:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">behav</span> <span class="o">=</span> <span class="s1">&#39;BMI&#39;</span>
<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">behavioral</span><span class="p">[</span><span class="n">behav</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span><span class="n">kde_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;KDE&quot;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/cpm_bevel_26_0.png" src="_images/cpm_bevel_26_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">behavioral</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">behav</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count    85.000000
mean     24.675294
std       3.153717
min      19.600000
25%      22.400000
50%      24.000000
75%      26.900000
max      33.100000
Name: BMI, dtype: float64
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="run-cpm-on-rl-tasks">
<h2>Run CPM on RL Tasks<a class="headerlink" href="#run-cpm-on-rl-tasks" title="Permalink to this headline">¶</a></h2>
<p>Tasks available:</p>
<ul class="simple">
<li><p>reward</p></li>
<li><p>punishment</p></li>
</ul>
<div class="section" id="punish">
<h3>Punish<a class="headerlink" href="#punish" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">condition</span><span class="o">=</span><span class="s2">&quot;punish&quot;</span>
<span class="n">matrices_path</span><span class="o">=</span><span class="s2">&quot;/content&quot;</span>
<span class="n">behav</span><span class="o">=</span><span class="s2">&quot;BMI&quot;</span>
<span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Oranges&quot;</span>
<span class="n">k</span><span class="o">=</span><span class="mi">100</span>
<span class="n">cond_color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span>
<span class="n">main</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">behav</span><span class="p">,</span><span class="n">cond_color</span><span class="p">,</span> <span class="n">matrices_path</span><span class="p">,</span><span class="n">cmap</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[INFO] Plot of the mean functional connectivity matrix: 
</pre></div>
</div>
<img alt="_images/cpm_bevel_30_1.png" src="_images/cpm_bevel_30_1.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[INFO] CPM completed with 100 folds.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BMI predicted (pos)</th>
      <th>BMI predicted (neg)</th>
      <th>BMI predicted (glm)</th>
      <th>BMI observed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sub-001</th>
      <td>24.1936</td>
      <td>24.8529</td>
      <td>24.3728</td>
      <td>24.5</td>
    </tr>
    <tr>
      <th>sub-002</th>
      <td>25.0752</td>
      <td>22.8593</td>
      <td>23.1775</td>
      <td>20.1</td>
    </tr>
    <tr>
      <th>sub-003</th>
      <td>23.2253</td>
      <td>25.2465</td>
      <td>23.8577</td>
      <td>30.8</td>
    </tr>
    <tr>
      <th>sub-004</th>
      <td>23.9218</td>
      <td>24.9591</td>
      <td>24.1364</td>
      <td>19.7</td>
    </tr>
    <tr>
      <th>sub-005</th>
      <td>26.0053</td>
      <td>25.0773</td>
      <td>26.3287</td>
      <td>19.6</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Plot of Observed vs. Predicted Behavior 
</pre></div>
</div>
<img alt="_images/cpm_bevel_30_5.png" src="_images/cpm_bevel_30_5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>For the pos tail, 3 edges were selected in at least 80.0% of folds
For the neg tail, 8 edges were selected in at least 80.0% of folds
</pre></div>
</div>
<img alt="_images/cpm_bevel_30_7.png" src="_images/cpm_bevel_30_7.png" />
<img alt="_images/cpm_bevel_30_8.png" src="_images/cpm_bevel_30_8.png" />
</div>
</div>
</div>
<div class="section" id="reward-task">
<h3>Reward Task<a class="headerlink" href="#reward-task" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">condition</span><span class="o">=</span><span class="s2">&quot;reward&quot;</span>
<span class="n">matrices_path</span><span class="o">=</span><span class="s2">&quot;/content&quot;</span>
<span class="n">behav</span><span class="o">=</span><span class="s2">&quot;BMI&quot;</span>
<span class="n">k</span><span class="o">=</span><span class="mi">100</span>
<span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span>
<span class="n">cond_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span>
<span class="n">main</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">behav</span><span class="p">,</span><span class="n">cond_color</span><span class="p">,</span> <span class="n">matrices_path</span><span class="p">,</span><span class="n">cmap</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[INFO] Plot of the mean functional connectivity matrix: 
</pre></div>
</div>
<img alt="_images/cpm_bevel_32_1.png" src="_images/cpm_bevel_32_1.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[INFO] CPM completed with 100 folds.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BMI predicted (pos)</th>
      <th>BMI predicted (neg)</th>
      <th>BMI predicted (glm)</th>
      <th>BMI observed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sub-001</th>
      <td>25.5391</td>
      <td>24.4024</td>
      <td>25.3002</td>
      <td>24.5</td>
    </tr>
    <tr>
      <th>sub-002</th>
      <td>24.2872</td>
      <td>23.7731</td>
      <td>23.3026</td>
      <td>20.1</td>
    </tr>
    <tr>
      <th>sub-003</th>
      <td>25.2684</td>
      <td>24.6154</td>
      <td>25.3452</td>
      <td>30.8</td>
    </tr>
    <tr>
      <th>sub-004</th>
      <td>24.6911</td>
      <td>25.1584</td>
      <td>25.1556</td>
      <td>19.7</td>
    </tr>
    <tr>
      <th>sub-005</th>
      <td>26.1608</td>
      <td>24.816</td>
      <td>26.3943</td>
      <td>19.6</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Plot of Observed vs. Predicted Behavior 
</pre></div>
</div>
<img alt="_images/cpm_bevel_32_5.png" src="_images/cpm_bevel_32_5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>For the pos tail, 8 edges were selected in at least 80.0% of folds
For the neg tail, 3 edges were selected in at least 80.0% of folds
</pre></div>
</div>
<img alt="_images/cpm_bevel_32_7.png" src="_images/cpm_bevel_32_7.png" />
<img alt="_images/cpm_bevel_32_8.png" src="_images/cpm_bevel_32_8.png" />
</div>
</div>
<p><strong>Reference:</strong><br />
<a class="reference external" href="https://github.com/esfinn/cpm_tutorial/blob/master/cpm_tutorial.ipynb">https://github.com/esfinn/cpm_tutorial/blob/master/cpm_tutorial.ipynb</a></p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "executablebooks/jupyter-book",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="decoding_brainwaves.html" title="previous page">Decoding Cocaine Brainwave Connectivity</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Nichollette Taylor Acosta<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>